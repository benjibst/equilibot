<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Equilibot Telemetry</title>
  <style>
    :root {
      --bg-a: #f4f6f8;
      --bg-b: #dbe8ef;
      --panel: #ffffff;
      --ink: #1d2a36;
      --muted: #5c7283;
      --x: #1b76d1;
      --y: #1d9d75;
      --z: #d43a4f;
      --line: #d3dde4;
      --online: #1f8f5f;
      --offline: #b04040;
      --pending: #b67912;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Space Grotesk", "Trebuchet MS", sans-serif;
      color: var(--ink);
      background: radial-gradient(circle at 15% 0, #ffffff 0%, var(--bg-a) 35%, var(--bg-b) 100%);
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 1.2rem;
      display: grid;
      gap: 1rem;
    }

    .top {
      background: var(--panel);
      border: 1px solid #e3e8ed;
      border-radius: 14px;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      box-shadow: 0 8px 24px rgba(37, 74, 103, 0.08);
    }

    h1 {
      margin: 0;
      font-size: 1.3rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .status {
      font-weight: 700;
    }

    .status.online {
      color: var(--online);
    }

    .status.offline {
      color: var(--offline);
    }

    .status.pending {
      color: var(--pending);
    }

    .readout {
      display: grid;
      grid-template-columns: repeat(2, minmax(260px, 1fr));
      gap: 1rem;
    }

    .panel {
      background: var(--panel);
      border: 1px solid #e3e8ed;
      border-radius: 14px;
      padding: 0.9rem 1rem;
      box-shadow: 0 8px 24px rgba(37, 74, 103, 0.08);
    }

    .panel h2 {
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
    }

    .config-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(170px, 1fr));
      gap: 0.65rem 0.9rem;
      align-items: end;
    }

    .field {
      display: grid;
      gap: 0.25rem;
    }

    .field label {
      color: var(--muted);
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-weight: 700;
    }

    .field select {
      width: 100%;
      border: 1px solid #ccd8e2;
      border-radius: 10px;
      padding: 0.42rem 0.5rem;
      background: #ffffff;
      color: var(--ink);
      font-size: 0.94rem;
    }

    .config-actions {
      grid-column: 1 / -1;
      display: flex;
      gap: 0.75rem;
      align-items: center;
      margin-top: 0.25rem;
    }

    .config-actions button {
      border: 1px solid #2c7fb3;
      background: #2c7fb3;
      color: #ffffff;
      border-radius: 10px;
      padding: 0.42rem 0.75rem;
      font-weight: 700;
      cursor: pointer;
    }

    .config-actions button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    .cfg-status {
      color: var(--muted);
      font-size: 0.85rem;
      font-weight: 700;
    }

    .cfg-status.err {
      color: var(--offline);
    }

    .axis-grid {
      display: grid;
      gap: 0.25rem;
    }

    .axis {
      display: flex;
      justify-content: space-between;
      gap: 0.8rem;
      font-variant-numeric: tabular-nums;
    }

    .axis .name {
      font-weight: 700;
      min-width: 2rem;
    }

    .axis .name.x {
      color: var(--x);
    }

    .axis .name.y {
      color: var(--y);
    }

    .axis .name.z {
      color: var(--z);
    }

    .charts {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .chart-card {
      background: var(--panel);
      border: 1px solid #e3e8ed;
      border-radius: 14px;
      padding: 0.8rem;
      box-shadow: 0 8px 24px rgba(37, 74, 103, 0.08);
    }

    .chart-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-bottom: 0.4rem;
    }

    .chart-title {
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
    }

    .legend {
      display: flex;
      gap: 0.8rem;
      font-size: 0.83rem;
    }

    .legend span {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .dot {
      width: 0.65rem;
      height: 0.65rem;
      border-radius: 50%;
    }

    .dot.x {
      background: var(--x);
    }

    .dot.y {
      background: var(--y);
    }

    .dot.z {
      background: var(--z);
    }

    canvas {
      width: 100%;
      height: 250px;
      display: block;
      border-radius: 10px;
      background: #f9fbfc;
      border: 1px solid var(--line);
    }

    @media (max-width: 900px) {
      .readout {
        grid-template-columns: 1fr;
      }

      .config-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <main class="wrap">
    <section class="top">
      <h1>Equilibot Live Telemetry</h1>
      <div class="status pending" id="wsStatus">Connecting...</div>
    </section>

    <section class="panel">
      <h2>IMU Runtime Config</h2>
      <div class="config-grid">
        <div class="field">
          <label for="cfgAccOdr">Accel ODR</label>
          <select id="cfgAccOdr"></select>
        </div>
        <div class="field">
          <label for="cfgGyroOdr">Gyro ODR</label>
          <select id="cfgGyroOdr"></select>
        </div>
        <div class="field">
          <label for="cfgAccFs">Accel Full Scale</label>
          <select id="cfgAccFs"></select>
        </div>
        <div class="field">
          <label for="cfgGyroFs">Gyro Full Scale</label>
          <select id="cfgGyroFs"></select>
        </div>
        <div class="field">
          <label for="cfgAccBw">Accel LPF BW</label>
          <select id="cfgAccBw"></select>
        </div>
        <div class="field">
          <label for="cfgGyroBw">Gyro LPF BW</label>
          <select id="cfgGyroBw"></select>
        </div>
        <div class="config-actions">
          <button id="cfgApplyBtn" type="button">Apply IMU Config</button>
          <span id="cfgStatus" class="cfg-status">No pending changes</span>
        </div>
      </div>
    </section>

    <section class="readout">
      <article class="panel">
        <h2>Acceleration (g)</h2>
        <div class="axis-grid">
          <div class="axis"><span class="name x">X</span><span id="accX">--</span></div>
          <div class="axis"><span class="name y">Y</span><span id="accY">--</span></div>
          <div class="axis"><span class="name z">Z</span><span id="accZ">--</span></div>
        </div>
      </article>
      <article class="panel">
        <h2>Gyroscope (dps)</h2>
        <div class="axis-grid">
          <div class="axis"><span class="name x">X</span><span id="gyroX">--</span></div>
          <div class="axis"><span class="name y">Y</span><span id="gyroY">--</span></div>
          <div class="axis"><span class="name z">Z</span><span id="gyroZ">--</span></div>
        </div>
      </article>
    </section>

    <section class="charts">
      <article class="chart-card">
        <div class="chart-head">
          <div class="chart-title">Acceleration Over Time</div>
          <div class="legend">
            <span><i class="dot x"></i>X</span>
            <span><i class="dot y"></i>Y</span>
            <span><i class="dot z"></i>Z</span>
          </div>
        </div>
        <canvas id="accChart"></canvas>
      </article>
      <article class="chart-card">
        <div class="chart-head">
          <div class="chart-title">Gyroscope Over Time</div>
          <div class="legend">
            <span><i class="dot x"></i>X</span>
            <span><i class="dot y"></i>Y</span>
            <span><i class="dot z"></i>Z</span>
          </div>
        </div>
        <canvas id="gyroChart"></canvas>
      </article>
    </section>
  </main>

  <script>
    const MAX_POINTS = 180;
    const COLORS = { x: "#1b76d1", y: "#1d9d75", z: "#d43a4f" };

    const accRaw = { t: [], x: [], y: [], z: [] };
    const gyroRaw = { t: [], x: [], y: [], z: [] };
    const latest = { acc: { x: null, y: null, z: null }, gyro: { x: null, y: null, z: null } };

    const wsStatus = document.getElementById("wsStatus");
    const accChart = document.getElementById("accChart");
    const gyroChart = document.getElementById("gyroChart");
    const cfgApplyBtn = document.getElementById("cfgApplyBtn");
    const cfgStatus = document.getElementById("cfgStatus");
    const cfgAccOdr = document.getElementById("cfgAccOdr");
    const cfgGyroOdr = document.getElementById("cfgGyroOdr");
    const cfgAccFs = document.getElementById("cfgAccFs");
    const cfgGyroFs = document.getElementById("cfgGyroFs");
    const cfgAccBw = document.getElementById("cfgAccBw");
    const cfgGyroBw = document.getElementById("cfgGyroBw");

    const ACC_ODR_OPTIONS = [
      { value: 5, label: "1600 Hz" },
      { value: 6, label: "800 Hz" },
      { value: 7, label: "400 Hz" },
      { value: 8, label: "200 Hz" },
      { value: 9, label: "100 Hz" },
      { value: 10, label: "50 Hz" },
      { value: 11, label: "25 Hz" },
      { value: 12, label: "12.5 Hz" },
      { value: 13, label: "6.25 Hz" },
      { value: 14, label: "3.125 Hz" },
      { value: 15, label: "1.5625 Hz" },
    ];
    const GYRO_ODR_OPTIONS = [
      { value: 5, label: "1600 Hz" },
      { value: 6, label: "800 Hz" },
      { value: 7, label: "400 Hz" },
      { value: 8, label: "200 Hz" },
      { value: 9, label: "100 Hz" },
      { value: 10, label: "50 Hz" },
      { value: 11, label: "25 Hz" },
      { value: 12, label: "12.5 Hz" },
    ];
    const ACC_FS_OPTIONS = [
      { value: 0, label: "±16 g" },
      { value: 1, label: "±8 g" },
      { value: 2, label: "±4 g" },
      { value: 3, label: "±2 g" },
    ];
    const GYRO_FS_OPTIONS = [
      { value: 0, label: "±2000 dps" },
      { value: 1, label: "±1000 dps" },
      { value: 2, label: "±500 dps" },
      { value: 3, label: "±250 dps" },
    ];
    const BW_OPTIONS = [
      { value: 0, label: "Bypass" },
      { value: 1, label: "180 Hz" },
      { value: 2, label: "121 Hz" },
      { value: 3, label: "73 Hz" },
      { value: 4, label: "53 Hz" },
      { value: 5, label: "34 Hz" },
      { value: 6, label: "25 Hz" },
      { value: 7, label: "16 Hz" },
    ];

    function setStatus(text, mode) {
      wsStatus.textContent = text;
      wsStatus.className = "status " + mode;
    }

    function setCfgStatus(text, isError) {
      cfgStatus.textContent = text;
      cfgStatus.className = isError ? "cfg-status err" : "cfg-status";
    }

    function populateSelect(selectElement, options, selectedValue) {
      selectElement.textContent = "";
      for (const option of options) {
        const node = document.createElement("option");
        node.value = String(option.value);
        node.textContent = option.label;
        if (option.value === selectedValue) {
          node.selected = true;
        }
        selectElement.appendChild(node);
      }
    }

    function initConfigForm() {
      populateSelect(cfgAccOdr, ACC_ODR_OPTIONS, 7);
      populateSelect(cfgGyroOdr, GYRO_ODR_OPTIONS, 7);
      populateSelect(cfgAccFs, ACC_FS_OPTIONS, 3);
      populateSelect(cfgGyroFs, GYRO_FS_OPTIONS, 3);
      populateSelect(cfgAccBw, BW_OPTIONS, 0);
      populateSelect(cfgGyroBw, BW_OPTIONS, 0);
      cfgApplyBtn.disabled = true;
      cfgApplyBtn.addEventListener("click", () => {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          setCfgStatus("WebSocket is not connected", true);
          return;
        }

        const configMessage = {
          type: "imu_config",
          config: {
            acce_odr: Number(cfgAccOdr.value),
            gyro_odr: Number(cfgGyroOdr.value),
            acce_fs: Number(cfgAccFs.value),
            gyro_fs: Number(cfgGyroFs.value),
            acce_bw: Number(cfgAccBw.value),
            gyro_bw: Number(cfgGyroBw.value),
          },
        };

        ws.send(JSON.stringify(configMessage));
        setCfgStatus("IMU config sent", false);
      });
    }

    function pushTelemetryBatch(series, rows) {
      if (!Array.isArray(rows)) {
        return null;
      }
      let latestVector = null;
      for (const row of rows) {
        if (!row || !Array.isArray(row.data) || row.data.length < 3) {
          continue;
        }
        const ts = Number(row.ts_ms);
        const x = Number(row.data[0]);
        const y = Number(row.data[1]);
        const z = Number(row.data[2]);
        if (!Number.isFinite(ts) || !Number.isFinite(x) || !Number.isFinite(y) || !Number.isFinite(z)) {
          continue;
        }
        series.t.push(ts);
        series.x.push(x);
        series.y.push(y);
        series.z.push(z);
        latestVector = { x, y, z };
        if (series.t.length > MAX_POINTS) series.t.shift();
        if (series.x.length > MAX_POINTS) series.x.shift();
        if (series.y.length > MAX_POINTS) series.y.shift();
        if (series.z.length > MAX_POINTS) series.z.shift();
      }
      return latestVector;
    }

    function fmt(value, digits) {
      return Number.isFinite(value) ? value.toFixed(digits) : "--";
    }

    function fmtTsSeconds(tsMs) {
      return Number.isFinite(tsMs) ? (tsMs / 1000).toFixed(3) + "s" : "--";
    }

    function refreshReadout() {
      document.getElementById("accX").textContent = fmt(latest.acc.x, 4);
      document.getElementById("accY").textContent = fmt(latest.acc.y, 4);
      document.getElementById("accZ").textContent = fmt(latest.acc.z, 4);
      document.getElementById("gyroX").textContent = fmt(latest.gyro.x, 3);
      document.getElementById("gyroY").textContent = fmt(latest.gyro.y, 3);
      document.getElementById("gyroZ").textContent = fmt(latest.gyro.z, 3);
    }

    function computeRange(minSpan, ...seriesList) {
      let min = Infinity;
      let max = -Infinity;
      for (const series of seriesList) {
        for (const axis of ["x", "y", "z"]) {
          for (const value of series[axis]) {
            if (value < min) min = value;
            if (value > max) max = value;
          }
        }
      }

      if (!Number.isFinite(min) || !Number.isFinite(max)) {
        return [-minSpan / 2, minSpan / 2];
      }

      const center = (min + max) / 2;
      const span = Math.max(max - min, minSpan) * 1.18;
      return [center - span / 2, center + span / 2];
    }

    function resizeCanvas(canvas) {
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      const width = Math.max(320, Math.floor(rect.width * dpr));
      const height = Math.max(180, Math.floor(rect.height * dpr));
      if (canvas.width !== width || canvas.height !== height) {
        canvas.width = width;
        canvas.height = height;
      }
    }

    function drawChart(canvas, series, yMin, yMax, unitLabel) {
      resizeCanvas(canvas);
      const ctx = canvas.getContext("2d");
      const w = canvas.width;
      const h = canvas.height;
      const pad = { l: 58, r: 14, t: 12, b: 28 };
      const pw = w - pad.l - pad.r;
      const ph = h - pad.t - pad.b;

      ctx.clearRect(0, 0, w, h);
      ctx.fillStyle = "#f9fbfc";
      ctx.fillRect(0, 0, w, h);

      ctx.strokeStyle = "#e2e9ef";
      ctx.lineWidth = 1;
      for (let i = 0; i <= 5; i += 1) {
        const y = pad.t + (ph * i) / 5;
        ctx.beginPath();
        ctx.moveTo(pad.l, y);
        ctx.lineTo(pad.l + pw, y);
        ctx.stroke();
      }

      const yToPx = (value) => pad.t + (1 - (value - yMin) / (yMax - yMin)) * ph;
      const tsValues = series.t;
      const tCount = tsValues.length;
      const tMin = tCount > 0 ? tsValues[0] : 0;
      const tMax = tCount > 0 ? tsValues[tCount - 1] : 0;
      const hasTimeRange = Number.isFinite(tMin) && Number.isFinite(tMax) && tMax > tMin;
      const xToPx = (ts, fallbackIndex) => {
        if (hasTimeRange && Number.isFinite(ts)) {
          return pad.l + ((ts - tMin) / (tMax - tMin)) * pw;
        }
        if (MAX_POINTS <= 1) return pad.l;
        return pad.l + (fallbackIndex / (MAX_POINTS - 1)) * pw;
      };

      if (yMin <= 0 && yMax >= 0) {
        ctx.strokeStyle = "#c2d0dd";
        ctx.beginPath();
        ctx.moveTo(pad.l, yToPx(0));
        ctx.lineTo(pad.l + pw, yToPx(0));
        ctx.stroke();
      }

      for (const axis of ["x", "y", "z"]) {
        const points = series[axis];
        if (points.length < 2) continue;
        ctx.strokeStyle = COLORS[axis];
        ctx.lineWidth = 2.0;
        ctx.beginPath();
        points.forEach((value, index) => {
          const ts = tsValues[index];
          const x = xToPx(ts, MAX_POINTS - points.length + index);
          const y = yToPx(value);
          if (index === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.stroke();
      }

      ctx.fillStyle = "#5c7283";
      ctx.font = "14px Trebuchet MS, sans-serif";
      ctx.textAlign = "left";
      ctx.fillText((yMax).toFixed(2) + " " + unitLabel, 8, pad.t + 10);
      ctx.fillText((yMin).toFixed(2) + " " + unitLabel, 8, pad.t + ph);
      ctx.fillText("t0 " + fmtTsSeconds(tMin), pad.l, h - 8);
      ctx.textAlign = "center";
      ctx.fillText(hasTimeRange ? ("span " + (tMax - tMin).toFixed(0) + " ms") : "span 0 ms", pad.l + pw / 2, h - 8);
      ctx.textAlign = "right";
      ctx.fillText("t1 " + fmtTsSeconds(tMax), w - 8, h - 8);
    }

    function render() {
      const accRange = computeRange(2.0, accRaw);
      const gyroRange = computeRange(250.0, gyroRaw);
      drawChart(accChart, accRaw, accRange[0], accRange[1], "g");
      drawChart(gyroChart, gyroRaw, gyroRange[0], gyroRange[1], "dps");
      requestAnimationFrame(render);
    }

    let ws = null;
    let reconnectTimer = null;

    function scheduleReconnect() {
      if (reconnectTimer !== null) {
        return;
      }
      reconnectTimer = setTimeout(() => {
        reconnectTimer = null;
        connectWebSocket();
      }, 1200);
    }

    function connectWebSocket() {
      setStatus("Connecting...", "pending");
      const protocol = window.location.protocol === "https:" ? "wss" : "ws";
      ws = new WebSocket(protocol + "://" + window.location.host + "/ws");

      ws.addEventListener("open", () => {
        setStatus("Connected", "online");
        cfgApplyBtn.disabled = false;
        setCfgStatus("Connected, ready to apply", false);
      });

      ws.addEventListener("message", (event) => {
        let message;
        try {
          message = JSON.parse(event.data);
        } catch (_ignored) {
          return;
        }

        if (!Array.isArray(message.acc) || !Array.isArray(message.gyro)) {
          return;
        }

        const latestAcc = pushTelemetryBatch(accRaw, message.acc);
        const latestGyro = pushTelemetryBatch(gyroRaw, message.gyro);

        if (latestAcc !== null) {
          latest.acc = latestAcc;
        }
        if (latestGyro !== null) {
          latest.gyro = latestGyro;
        }
        refreshReadout();
      });

      ws.addEventListener("close", () => {
        setStatus("Disconnected, retrying...", "offline");
        cfgApplyBtn.disabled = true;
        setCfgStatus("Disconnected", true);
        scheduleReconnect();
      });

      ws.addEventListener("error", () => {
        setStatus("Socket error", "offline");
        cfgApplyBtn.disabled = true;
        setCfgStatus("Socket error", true);
        if (ws && ws.readyState <= 1) {
          ws.close();
        }
      });
    }

    initConfigForm();
    refreshReadout();
    render();
    connectWebSocket();
  </script>
</body>

</html>
